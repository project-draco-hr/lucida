{
  ByteArrayOutputStream baos=new ByteArrayOutputStream();
  WriteCountingTransport countingTrans=new WriteCountingTransport(new TIOStreamTransport(new BufferedOutputStream(baos)));
  TTransport trans=getTransport(countingTrans);
  trans.write(byteSequence(0,100));
  assertEquals(1,countingTrans.writeCount);
  trans.write(byteSequence(101,200));
  trans.write(byteSequence(201,255));
  assertEquals(1,countingTrans.writeCount);
  trans.flush();
  assertEquals(2,countingTrans.writeCount);
  trans.write(byteSequence(0,245));
  trans.flush();
  assertEquals(3,countingTrans.writeCount);
  DataInputStream din=new DataInputStream(new InflaterInputStream(new ByteArrayInputStream(baos.toByteArray())));
  byte[] buf=new byte[256];
  int n=din.read(buf,0,256);
  assertEquals(n,256);
  assertTrue(Arrays.equals(byteSequence(0,255),buf));
  buf=new byte[246];
  n=din.read(buf,0,246);
  assertEquals(n,246);
  for (int i=0; i < buf.length; i++) {
    assertEquals("for " + i,byteSequence(0,245)[i],buf[i]);
  }
  assertTrue(Arrays.equals(byteSequence(0,245),buf));
}
